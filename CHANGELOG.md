# Changelog

Все значимые изменения в проекте Bitrix24 Audit Scripts документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2.1.0] - 2024-12-19

### Добавлено

- **Новый модуль Битрикс** `collect_bitrix.sh` для комплексного анализа Битрикс24 и Bitrix Framework
- **Анализ кеша Битрикс**:
  - Размеры директорий кеша (cache, managed_cache, stack_cache, upload)
  - Количество файлов и их типы
  - Возраст файлов (кандидаты на очистку)
  - Топ-10 самых больших файлов
  - Анализ использования дискового пространства
- **Анализ настроек Битрикс**:
  - Поиск и анализ файлов `.settings.php`
  - Извлечение конфигурации `exception_handling`
  - Проверка прав доступа к файлам настроек
  - Анализ логов исключений
  - Поддержка многосайтовых конфигураций
- **Генерация рекомендаций**:
  - Рекомендации по очистке кеша
  - Предупреждения о критических размерах
  - Советы по оптимизации производительности
  - Рекомендации по безопасности
- **Интеграция с системой анализа**:
  - Функция `analyze_bitrix_cache()` в `analyze_and_recommend.sh`
  - Автоматическая генерация приоритизированных рекомендаций
  - Включение в JSON отчеты
- **Поддержка в оркестраторе**:
  - Опция `--bitrix` для запуска модуля
  - Включение в режим `--all`
  - Проверка требований (наличие `/home/bitrix`)
- **Документация**:
  - `docs/bitrix-audit.md` - подробная документация модуля
  - `docs/bitrix-optimization.md` - рекомендации по оптимизации Битрикс
  - Обновлен `README.md` с описанием нового модуля

### Изменено

- **Перенос функционала** из `collect_php.sh`:
  - Анализ `.settings.php` файлов перенесен в `collect_bitrix.sh`
  - Анализ `exception_handling` перенесен в `collect_bitrix.sh`
  - Оставлена ссылка на новый модуль в `collect_php.sh`
- **Обновлен оркестратор** `run_all_audits.sh`:
  - Добавлена поддержка модуля `bitrix`
  - Обновлен комментарий с опцией `--bitrix`
  - Добавлен модуль в список по умолчанию

### Технические детали

- **Переменные окружения** для настройки анализа:
  - `BITRIX_CACHE_MAX_AGE_DAYS=30` - максимальный возраст файлов
  - `BITRIX_CACHE_WARNING_SIZE_GB=5` - предупреждающий размер кеша
  - `BITRIX_CACHE_CRITICAL_SIZE_GB=10` - критический размер кеша
  - `BITRIX_CACHE_DISK_PCT_CRITICAL=20` - критический процент диска
- **Безопасность**: использование `find` с `-xdev`, ограничение глубины поиска
- **Производительность**: параллельный анализ сайтов, ограничение вывода
- **Совместимость**: поддержка Bitrix24 коробочной версии и Bitrix Framework

## [2.0.0] - 2024-01-15

### Добавлено

- **Единый оркестратор** `run_all_audits.sh` для запуска всех аудитов
- **Конфигурационный файл** `audit.conf.example` с настройками локалей
- **Скрипт проверки требований** `check_requirements.sh` с проверкой локалей
- **Общие функции локалей** в `audit_common.sh`:
  - `locale_has()` - проверка наличия локали
  - `setup_locale()` - настройка локалей
  - `with_locale()` - запуск команд с правильными локалями
  - `check_requirements()` - проверка зависимостей
  - `have()` - проверка наличия команды
- **Документация**:
  - `README.md` с разделом о важности локалей
  - `REQUIREMENTS.md` с детальными требованиями к локалям
  - `docs/locales-and-dates.md` - документация по работе с локалями
- **Версионирование** во всех основных скриптах
- **Поддержка параллельного выполнения** в оркестраторе
- **Централизованное логирование** всех операций
- **Сводные отчеты** со статусом каждого модуля
- **Автоматическое создание архивов** с ротацией

### Изменено

- **Рефакторинг всех скриптов** для использования общих функций локалей
- **Унификация логики локалей** - убрано дублирование кода
- **Улучшена обработка ошибок** с продолжением работы при сбоях
- **Оптимизирована работа с датами** - критично для atop/sar
- **Улучшена совместимость** с различными дистрибутивами Linux

### Исправлено

- **Критические проблемы с парсингом дат** в atop и sar
- **Дублирование кода** в 13 скриптах (50-80 строк в каждом)
- **Несовместимость локалей** между различными утилитами
- **Проблемы с awk** при работе с числами
- **Отсутствие централизованного управления** аудитами

### Удалено

- **Дублирующийся код локалей** из всех скриптов
- **Неиспользуемые переменные** (NC, SOCAT, XXD в collect_nginx.sh)
- **Множественные source audit_common.sh** в некоторых скриптах

### Безопасность

- **Улучшена изоляция процессов** через sterile environment
- **Защита от интерактивных меню** Bitrix
- **Безопасная работа с временными файлами**

## [1.x] - Предыдущие версии

### [1.0.0] - 2023-12-01

#### Добавлено

- **Базовые скрипты аудита**:
  - `collect_nginx.sh` - сбор данных nginx
  - `collect_apache.sh` - сбор данных apache
  - `collect_mysql.sh` - сбор данных mysql
  - `collect_php.sh` - сбор данных php
  - `collect_redis.sh` - сбор данных redis
  - `collect_system_info.sh` - сбор системной информации
  - `collect_atop.sh` - сбор данных atop
  - `collect_sar.sh` - сбор данных sar
  - `collect_cron.sh` - сбор данных cron
- **Скрипты анализа ошибок**:
  - `analyze_nginx_errors.sh` - анализ логов ошибок nginx
  - `analyze_apache_errors.sh` - анализ логов ошибок apache
- **Общие функции** в `audit_common.sh`
- **Makefile** для сборки и проверки
- **Документация** `README-nginx-audit.md`

#### Известные проблемы

- **Дублирование кода локалей** во всех скриптах
- **Проблемы с парсингом дат** в atop и sar
- **Отсутствие единого оркестратора**
- **Недостаточная документация** по локалям
- **Отсутствие проверки требований**

## Планы на будущее

### [2.1.0] - Планируется

#### Добавлено

- **Поддержка Docker** для изолированного выполнения
- **Интеграция с мониторингом** (Prometheus, Grafana)
- **Автоматические уведомления** по email/Slack
- **Веб-интерфейс** для просмотра результатов
- **API** для интеграции с внешними системами

#### Изменено

- **Улучшена производительность** сбора данных
- **Расширена поддержка** различных дистрибутивов
- **Оптимизированы алгоритмы** анализа данных

### [2.2.0] - Планируется

#### Добавлено

- **Поддержка кластеров** Bitrix24
- **Анализ производительности** баз данных
- **Мониторинг в реальном времени**
- **Автоматические рекомендации** по оптимизации

#### Изменено

- **Переход на Python** для сложной аналитики
- **Улучшена масштабируемость** для больших систем

## Примечания по версионированию

### Семантическое версионирование

- **MAJOR** (X.0.0) - несовместимые изменения API
- **MINOR** (X.Y.0) - новая функциональность с обратной совместимостью
- **PATCH** (X.Y.Z) - исправления ошибок с обратной совместимостью

### Критерии для MAJOR версии

- Изменение формата выходных данных
- Изменение API скриптов
- Удаление устаревших функций
- Изменение требований к системе

### Критерии для MINOR версии

- Добавление новых модулей аудита
- Новые функции в существующих модулях
- Улучшения производительности
- Новая документация

### Критерии для PATCH версии

- Исправления ошибок
- Улучшения безопасности
- Обновления документации
- Исправления опечаток

## Миграция между версиями

### С v1.x на v2.0.0

#### Критические изменения

1. **Новые требования к локалям**:
   ```bash
   # Установите необходимые локали
   sudo locale-gen en_US.UTF-8 ru_RU.UTF-8
   ```

2. **Новый оркестратор**:
   ```bash
   # Вместо запуска отдельных скриптов
   ./run_all_audits.sh --all
   ```

3. **Конфигурационный файл**:
   ```bash
   # Создайте конфигурацию
   cp audit.conf.example audit.conf
   # Отредактируйте под ваши нужды
   ```

#### Рекомендации по миграции

1. **Проверьте требования**:
   ```bash
   ./check_requirements.sh --verbose
   ```

2. **Протестируйте новый оркестратор**:
   ```bash
   ./run_all_audits.sh --nginx --mysql
   ```

3. **Обновите автоматизацию**:
   ```bash
   # Обновите crontab
   0 2 * * * /path/to/Audit-Bitrix24/run_all_audits.sh --all
   ```

## Поддержка

### Получение помощи

- **Документация**: README.md, REQUIREMENTS.md
- **Проверка требований**: ./check_requirements.sh
- **Логи**: /root/audit/audit_run.log
- **Отчеты**: /root/audit/SUMMARY_ALL.md

### Сообщение об ошибках

При сообщении об ошибках укажите:

1. **Версию скриптов**: `./run_all_audits.sh --version`
2. **Информацию о системе**: `uname -a`
3. **Настройки локалей**: `locale`
4. **Логи выполнения**: `/root/audit/audit_run.log`
5. **Результат проверки требований**: `./check_requirements.sh --verbose`

### Вклад в проект

Мы приветствуем вклад в развитие проекта:

1. **Fork** репозитория
2. **Создайте ветку** для новой функции
3. **Сделайте изменения** с тестами
4. **Создайте Pull Request** с описанием изменений

## Лицензия

MIT License - см. файл LICENSE для деталей.
