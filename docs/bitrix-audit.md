# Bitrix Audit Module Documentation

## Обзор

Модуль `collect_bitrix.sh` предназначен для комплексного анализа установок Битрикс24 и Bitrix Framework. Он собирает информацию о конфигурации, анализирует директории кеша и генерирует рекомендации по оптимизации.

## Возможности

### Анализ настроек Битрикс
- Поиск и анализ файлов `.settings.php`
- Извлечение конфигурации `exception_handling`
- Проверка прав доступа к файлам настроек
- Анализ логов исключений
- Поддержка многосайтовых конфигураций

### Анализ кеша
- Анализ размеров директорий кеша
- Подсчет количества файлов и их типов
- Определение возраста файлов
- Поиск самых больших файлов
- Анализ использования дискового пространства

### Генерация рекомендаций
- Рекомендации по очистке кеша
- Предупреждения о критических размерах
- Советы по оптимизации производительности
- Рекомендации по безопасности

## Использование

### Базовое использование

```bash
# Полный анализ (настройки + кеш)
./collect_bitrix.sh

# Только анализ кеша
./collect_bitrix.sh --cache-only

# Только анализ настроек
./collect_bitrix.sh --settings-only

# Подробный вывод
./collect_bitrix.sh --verbose
```

### Интеграция с оркестратором

```bash
# Запуск только модуля Битрикс
./run_all_audits.sh --bitrix

# Запуск всех модулей включая Битрикс
./run_all_audits.sh --all
```

## Конфигурация

### Переменные окружения

```bash
# Максимальный возраст файлов для анализа (дни)
BITRIX_CACHE_MAX_AGE_DAYS=30

# Предупреждающий размер кеша (GB)
BITRIX_CACHE_WARNING_SIZE_GB=5

# Критический размер кеша (GB)
BITRIX_CACHE_CRITICAL_SIZE_GB=10

# Критический процент использования диска
BITRIX_CACHE_DISK_PCT_CRITICAL=20
```

### Пути для анализа

Модуль автоматически ищет установки Битрикс в следующих местах:

- `/home/bitrix/www` - основная установка
- `/home/bitrix/ext_www/*` - дополнительные сайты

Для каждого сайта анализируются директории:
- `bitrix/cache/` - основной кеш
- `bitrix/managed_cache/` - управляемый кеш
- `bitrix/stack_cache/` - стековый кеш
- `upload/` - загруженные файлы

## Выходные данные

### Структура файлов

```
$AUDIT_DIR/bitrix_audit/
├── cache_analysis.txt          # Детальный анализ кеша
├── cache_recommendations.txt   # Рекомендации по кешу
├── settings_analysis.txt       # Анализ настроек
├── settings_recommendations.txt # Рекомендации по настройкам
├── summary.txt                # Сводка анализа
├── main.settings.php          # Копия файла настроек основного сайта
├── main.exception_handling.txt # Конфигурация exception_handling
├── main.exception_handling.json # JSON версия конфигурации
└── site1.settings.php         # Настройки дополнительных сайтов
```

### Формат анализа кеша

```
=== Сайт: main ===
Путь: /home/bitrix/www

Директория: cache
  Размер: 1024 MB (1 GB)
  Файлов: 5000
  Старых файлов (>30 дней): 1000
  Типы файлов:
    PHP: 3000
    HTML: 1500
    TXT: 400
    Другие: 100
  Топ-10 больших файлов:
    50 MB: /home/bitrix/www/bitrix/cache/large_file.php
    ...
```

### Формат рекомендаций

```
[КРИТИЧНО] Общий размер кеша 15 GB превышает критический порог
[ВНИМАНИЕ] Найдено 5000 старых файлов кеша
[РЕКОМЕНДАЦИЯ] Настройте автоматическую очистку кеша через cron
[РЕКОМЕНДАЦИЯ] Рассмотрите использование Memcached/Redis для кеширования
```

## Интерпретация результатов

### Критерии критичности

- **КРИТИЧНО**: Размер кеша > 10GB или использование диска > 20%
- **ВНИМАНИЕ**: Размер кеша > 5GB или много старых файлов
- **РЕКОМЕНДАЦИЯ**: Общие советы по оптимизации

### Типичные проблемы

1. **Большой размер кеша**
   - Причина: Накопление файлов кеша без очистки
   - Решение: Настроить автоматическую очистку

2. **Много старых файлов**
   - Причина: Отсутствие ротации кеша
   - Решение: Регулярная очистка файлов старше 30 дней

3. **Небезопасные права доступа**
   - Причина: Файлы настроек доступны для чтения всем
   - Решение: Установить права 600 или 640

## Команды для ручной очистки

### Очистка кеша Битрикс

```bash
# Очистка основного кеша
find /home/bitrix/www/bitrix/cache -type f -mtime +30 -delete

# Очистка управляемого кеша
find /home/bitrix/www/bitrix/managed_cache -type f -mtime +30 -delete

# Очистка стекового кеша
find /home/bitrix/www/bitrix/stack_cache -type f -mtime +30 -delete

# Очистка для всех сайтов
find /home/bitrix/ext_www/*/bitrix/cache -type f -mtime +30 -delete
```

### Настройка автоматической очистки

Создайте cron задачу для автоматической очистки:

```bash
# Добавить в crontab
0 2 * * * find /home/bitrix -path "*/bitrix/cache/*" -type f -mtime +30 -delete
0 2 * * * find /home/bitrix -path "*/bitrix/managed_cache/*" -type f -mtime +30 -delete
0 2 * * * find /home/bitrix -path "*/bitrix/stack_cache/*" -type f -mtime +30 -delete
```

## Интеграция с анализом

Модуль интегрирован с системой анализа и рекомендаций:

1. **analyze_and_recommend.sh** - автоматически анализирует результаты
2. **Генерация приоритизированных рекомендаций** - включает проблемы Битрикс
3. **JSON отчеты** - структурированные данные для мониторинга

## Мониторинг

### Ключевые метрики

- Общий размер кеша всех сайтов
- Количество старых файлов
- Использование дискового пространства
- Количество сайтов в многосайтовой конфигурации

### Алерты

Настройте мониторинг следующих параметров:
- Размер кеша > 5GB (предупреждение)
- Размер кеша > 10GB (критично)
- Использование диска > 20% (критично)
- Количество старых файлов > 1000 (внимание)

## Troubleshooting

### Частые проблемы

1. **Модуль не находит установки Битрикс**
   - Проверьте наличие директории `/home/bitrix`
   - Убедитесь в правильности путей к сайтам

2. **Ошибки доступа к файлам**
   - Проверьте права доступа к директориям
   - Запускайте от пользователя с достаточными правами

3. **Медленная работа анализа**
   - Используйте `--cache-only` для быстрого анализа
   - Ограничьте глубину поиска файлов

### Логирование

Модуль выводит подробную информацию при использовании `--verbose`:
- Прогресс анализа каждого сайта
- Детали обработки файлов
- Статистику по директориям

## Примеры использования

### Ежедневный мониторинг

```bash
# Быстрая проверка размера кеша
./collect_bitrix.sh --cache-only --verbose
```

### Полный аудит

```bash
# Комплексный анализ с рекомендациями
./run_all_audits.sh --bitrix
```

### Анализ конкретного сайта

```bash
# Анализ только настроек
./collect_bitrix.sh --settings-only
```

## Совместимость

- **Bitrix24**: Коробочная версия
- **Bitrix Framework**: Все версии
- **Многосайтовость**: Полная поддержка
- **ОС**: Linux (тестировано на Ubuntu, CentOS, Debian)
